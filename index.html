<!doctype html>
<html prefix="og: http://ogp.me/ns#" lang="en" itemscope itemtype="http://schema.org/Article">
<head>
   <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">   
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

     <!-- g+ -->
    <meta itemprop="name" content="spleen.noo.name - Escher-Droste Effect - Three.js + WebGL">
    <meta itemprop="description" content="Hola! Here's my studium, aiming to realize the well-known Escher-Droste effect.
1 point light, some post-fx &amp; simple lambertian diffusion.  Play with controls. Needs a WebGL enabled browser (latest Chrome/Safari, IE11+, safari 8) (credits: TOOL &amp; the beautiful art of Alex Grey )">
    <meta itemprop="image" content="https://dl.dropboxusercontent.com/u/1358781/lab/webgl/preview_tw.jpg"/>

        <!-- Open Graph data -->
    <meta property="og:title" content="spleen.noo.name - Escher-Droste Effect - Three.js + WebGL" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="http://spleen.noo.name/lab/webgl/escher-droste+three/index.html" />
    <meta property="og:image" content="https://dl.dropboxusercontent.com/u/1358781/lab/webgl/preview_tw.jpg" />
    <meta property="og:description" content="Hola! Here's my studium, aiming to realize the well-known Escher-Droste effect.
1 point light, some post-fx &amp; simple lambertian diffusion.  Play with controls. Needs a WebGL enabled browser (latest Chrome/Safari, IE11+, safari 8) (credits: TOOL&amp; the beautiful art of Alex Grey )" />
    <meta property="og:site_name" content="spleen.noo.name" />

    <title>spleen.noo.name - Escher-Droste Effect - Three.js + WebGL</title>

    	<script id="droste-vs" type="x-shader/x-vertex">

  	 	#ifdef GL_ES
   	     	precision highp float;
        #endif
   
  	    varying vec2 vUv;
  	    varying vec3 vNormal;
		varying vec3 vViewPosition;
		varying vec3 vModelPosition;

		void main() {

			//transform the vertex  from model space to clip coordinates
		    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);

		    vNormal = normalize( normal *normalMatrix);

		    vec4 mvPosition = modelMatrix * vec4(position, 1.0 );

		    vViewPosition = -mvPosition.xyz;

		    vModelPosition = position;
		    
		    //texture position
		    vUv = uv;

		}

	</script>
	<script  id="droste-fs" type="x-shader/x-fragment">

	        #ifdef GL_ES
   	     	 	precision highp float;
        	#endif

        	#define pi 3.14159265358979323846
        	#define factor 256.0
        	#define pi2 6.2831853071
        	
        	/* three */

	   		varying vec2 vUv;
			varying vec3 vNormal;
			varying vec3 vViewPosition;
			varying vec3 vModelPosition;

			/* lights */

			uniform vec3 pointLightColor[MAX_POINT_LIGHTS];
			uniform vec3 pointLightPosition[MAX_POINT_LIGHTS];
			uniform float pointLightDistance[MAX_POINT_LIGHTS];

			uniform vec3 uSpecularColor;
			uniform float uKd;
			uniform float uKs;
			uniform float shininess;

			/* escher-droste */
	
	   		uniform sampler2D texture;
        	uniform vec2 size;        	
        	uniform float time;
        	uniform float p1,p2;
               	
        	vec2 cmul(vec2 a,vec2 b) {
            	return vec2(a.x*b.x - a.y*b.y, a.x*b.y + a.y*b.x );
	        }
	         
	        vec2 clog(vec2 v) {
	         	return vec2( 0.5 * log(v.x*v.x+v.y*v.y), atan(v.y,v.x) );
	        }	         

			void main() {

				vec2 pos = -1.0 + 2.0 * vUv;		

				/* escher-droste */
					
         		vec2 logpos = clog(pos);                  
         		vec2 transformed = cmul( logpos, vec2(p2, -p1*log(factor)/pi2 ) );
         		vec2 uv = vec2( -transformed.y/pi2, transformed.x/log(factor) - time *.2 );   
         		vec3 color = texture2D( texture, uv).rgb;

      			float diffuse = 0.0;
      			float specular =0.0;
      			vec4 lights = vec4(0.0, 0.0, 0.0, 1.0);
         		for(int i = 0; i < MAX_POINT_LIGHTS; i++) {

         			// compute direction to light
					vec3 L = normalize( vec3( viewMatrix * vec4( pointLightPosition[i], 0.0 ) ).xyz);
					vec3 N = normalize( vNormal );

					// compute larmbertian diffusion	
					diffuse = max( dot( N, L ), 0.0);

					// specular: N * H to a power. H is light vector + view vector
					vec3 viewPosition = normalize( vViewPosition );
					vec3 pointHalfVector = normalize( L + viewPosition );
					float pointDotNormalHalf = max( dot( vNormal, pointHalfVector ), 0.0 );
					specular = uKs * pow( pointDotNormalHalf, shininess );
					specular *= (8.0 + shininess)/(8.0*3.14);

					// however, if N * L is < 0, the light is below the horizon and should not affect the surface
					// This can give a hard termination to the highlight, but it's better than some weird sparkle.
					if (diffuse <= 0.0) {
						specular = 0.0;
					}
				 		
					lights.rgb += diffuse * pointLightColor[i] + uSpecularColor * specular;
         		}
			
         		color *= lights.rgb;
         		
         		/** post film +noise+scanlines *

         		float sCount = 512.0;
         		float sIntensity = .45;
         		float nIntensity = .65;
         		// sample the source
				vec3 cTextureScreen = color;
				// make some noise
				float x = pos.x * pos.y * time *  1000.0;
				x = mod( x, 13.0 ) * mod( x, 123.0 );
				float dx = mod( x, 0.01 );
				// add noise
				vec3 cResult = cTextureScreen + cTextureScreen * clamp( 0.1 + dx * 100.0, 0.0, 1.0 );
				// get us a sine and cosine
				vec2 sc = vec2( sin( pos.y * sCount ), cos( pos.y * sCount ) );
				// add scanlines
				cResult += cTextureScreen * vec3( sc.x, sc.y, sc.x ) * sIntensity;
				// interpolate between source and result by intensity
				cResult = cTextureScreen + clamp( nIntensity, 0.0,1.0 ) * ( cResult - cTextureScreen );
				color = cResult;*/




         	    //vignetting
         	    //float vignette = 1. - dot( pos*.25, pos*.25);
    			//color *= vignette;

    			
				//out
                gl_FragColor = vec4( color, 1.0);
			}

	   </script>
	   <link rel="stylesheet" media="screen" href="css/style.css" />    
	       <!-- Hotjar Tracking Code for http://spleen.noo.name -->
    <script>
        (function(h,o,t,j,a,r){
            h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
            h._hjSettings={hjid:140549,hjsv:5};
            a=o.getElementsByTagName('head')[0];
            r=o.createElement('script');r.async=1;
            r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
            a.appendChild(r);
        })(window,document,'//static.hotjar.com/c/hotjar-','.js?sv=');
    </script>

</head>

<body oncontextmenu="return false">
	<div class="" id="canvas"></div>
   	<script src="js/escher-droste.min.js"></script>
</body>
</html>